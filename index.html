<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ¤å°¾ äº®ä¼ | Hadron Lab Ver 8.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=M+PLUS+Rounded+1c:wght@700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* ===== Hadron Lab 8.1 Layout Fix ===== */
        :root {
            --hc-bg: #0a0e14;
            --hc-panel: #151922;
            --hc-border: #333;
            --hc-orange: #f39c12;
            --hc-blue: #3498db;
            --hc-green: #2ecc71;
            --hc-purple: #9b59b6;
            --hc-red: #e74c3c;
            --hc-text: #ecf0f1;
        }

        body { margin: 0; background: var(--hc-bg); color: var(--hc-text); font-family: 'M PLUS Rounded 1c', sans-serif; overflow: hidden; user-select: none; }

        /* èƒŒæ™¯ */
        .lab-container {
            width: 100vw; height: 100vh; position: relative;
            background-image: url('images/lab_bg.png'); 
            background-size: cover; background-position: center; 
            background-color: var(--hc-bg);
        }

        /* ãƒˆãƒƒãƒ—ãƒãƒ¼ */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 50px;
            background: rgba(0,0,0,0.6); 
            display: flex; align-items: center; padding: 0 20px; gap: 20px; z-index: 100;
        }
        .status-box {
            background: rgba(40, 50, 60, 0.8); padding: 5px 15px; border-radius: 2px; border: 1px solid #555;
            display: flex; align-items: center; gap: 10px; font-family: 'Orbitron'; font-size: 0.9rem;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            position: absolute; top: 50px; left: 0; bottom: 0; width: 60px;
            background: rgba(0,0,0,0.8); border-right: 1px solid #444; 
            display: flex; flex-direction: column; z-index: 90; transition: 0.2s; overflow: hidden;
        }
        .sidebar:hover { width: 220px; }
        .menu-item {
            height: 50px; display: flex; align-items: center; padding-left: 15px;
            color: #aaa; cursor: pointer; white-space: nowrap; transition: 0.2s; border-bottom: 1px solid #222;
        }
        .menu-item:hover, .menu-item.active { background: var(--hc-blue); color: white; }
        .menu-icon { width: 30px; font-size: 1.2rem; text-align: center; margin-right: 10px; }

        /* ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ */
        .main-view {
            position: absolute; top: 50px; left: 0; right: 0; bottom: 0;
            padding: 40px; overflow-y: auto; display: none;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            animation: fadeIn 0.3s; z-index: 80; padding-left: 80px;
        }
        .main-view.active { display: block; }

        /* --- ãƒ›ãƒ¼ãƒ ç”»é¢ (ãƒ‡ãƒƒã‚­è¡¨ç¤º) --- */
        #view-home { background: transparent; backdrop-filter: none; pointer-events: none; }
        
        /* â˜…ä¿®æ­£ï¼šãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½ç½®ã‚’å·¦å´ã«å›ºå®š */
        .home-menu-container {
            position: absolute; 
            top: 55%; 
            left: 150px; /* å·¦ç«¯ã‹ã‚‰150pxã®ä½ç½® */
            transform: translateY(-50%);
            width: 450px; height: 450px; 
            pointer-events: auto; z-index: 50;
        }

        /* ã‚®ã‚¢ãƒœã‚¿ãƒ³ */
        .gear-btn {
            position: absolute; border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            cursor: pointer; transition: 0.2s;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            font-family: 'Orbitron'; font-weight: bold; border: 2px solid rgba(255,255,255,0.2);
            background-color: rgba(0,0,0,0.8); /* èƒŒæ™¯ã‚’å°‘ã—æš—ãã—ã¦èª­ã¿ã‚„ã™ã */
        }
        .gear-btn:hover { transform: scale(1.1); z-index: 100; filter: brightness(1.2); border-color: white; }
        .gear-btn::before {
            content: ""; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px;
            border-radius: 50%; border: 2px dashed rgba(255,255,255,0.3);
            animation: spin 20s linear infinite; pointer-events: none;
        }

        /* ãƒœã‚¿ãƒ³é…ç½®ã®å¾®èª¿æ•´ */
        .btn-main { width: 170px; height: 170px; background: radial-gradient(circle, #e67e22, #d35400); border: 4px solid #f1c40f; color: #fff; font-size: 1.4rem; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; }
        .btn-shop { width: 100px; height: 100px; background: #2ecc71; color: white; top: 15%; left: 15%; font-size: 0.8rem; }
        .btn-deck { width: 100px; height: 100px; background: #9b59b6; color: white; top: 70%; left: 15%; font-size: 0.8rem; }
        .btn-office { width: 100px; height: 100px; background: #3498db; color: white; top: 85%; left: 50%; transform: translateX(-50%); font-size: 0.8rem; }
        .btn-battle { width: 110px; height: 110px; background: #c0392b; color: white; top: 65%; right: 5%; font-size: 0.9rem; border-color: #e74c3c; }
        .btn-craft { width: 100px; height: 100px; background: #7f8c8d; color: white; top: 15%; right: 15%; font-size: 0.9rem; } /* å·¥å» ã‚’å³ä¸Šã«ç§»å‹• */

        /* â˜…ä¿®æ­£ï¼šãƒ‡ãƒƒã‚­è¡¨ç¤ºã‚¨ãƒªã‚¢ (å³ä¸‹ã«é…ç½®ãƒ»é‡ãªã‚Šèª¿æ•´) */
        .deck-display-area {
            position: absolute; right: 20px; bottom: 20px; 
            height: 60vh; width: 60vw;
            pointer-events: none; 
            display: flex; justify-content: flex-end; align-items: flex-end;
            z-index: 10;
        }
        .deck-member {
            width: 220px; /* ã‚«ãƒ¼ãƒ‰å¹…å›ºå®š */
            height: auto; 
            object-fit: contain;
            margin-right: -120px; /* ã‚«ãƒ¼ãƒ‰ã‚’é‡ã­ã‚‹ */
            border-radius: 10px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.8); /* å½±ã‚’ã¤ã‘ã¦ç«‹ä½“æ„Ÿ */
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            pointer-events: auto; cursor: pointer;
            transform-origin: bottom center;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .deck-member:hover { 
            transform: translateY(-30px) scale(1.1); /* ãƒ›ãƒãƒ¼ã§æŒã¡ä¸ŠãŒã‚‹ */
            z-index: 100; 
            margin-right: -20px; /* æ¨ªã®é–“éš”ã‚’åºƒã’ã‚‹ */
            box-shadow: 0 0 30px rgba(255,255,255,0.4);
            border-color: white;
        }
        
        /* æ——è‰¦ï¼ˆä¸€ç•ªå³ã¾ãŸã¯ä¸€ç•ªæ‰‹å‰ï¼‰ã®ç‰¹åˆ¥æ‰±ã„ */
        .deck-member.flagship {
            width: 260px; /* å°‘ã—å¤§ãã */
            z-index: 20;
            border: 2px solid var(--hc-orange);
        }

        /* --- ç·¨æˆç”»é¢ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .deck-slots { display: flex; justify-content: space-around; gap: 10px; margin-bottom: 30px; }
        .slot-card {
            width: 18%; background: #222; border: 2px dashed #555; height: 250px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; border-radius: 10px; position: relative; overflow: hidden;
        }
        .slot-card:hover { border-color: var(--hc-green); background: #2a2a2a; }
        .slot-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        .slot-label {
            position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.8);
            text-align: center; padding: 5px 0; font-weight: bold; color: var(--hc-orange);
        }
        .slot-remove {
            position: absolute; top: 5px; right: 5px; background: red; width: 20px; height: 20px;
            border-radius: 50%; text-align: center; line-height: 20px; font-size: 0.8rem; z-index: 5;
        }

        /* å…±é€š */
        .shop-grid, .craft-grid, .particle-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .item-card { background: var(--hc-panel); border: 1px solid #444; padding: 10px; text-align: center; cursor: pointer; border-radius: 5px; }
        .item-card:hover { background: #333; border-color: #888; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #222; padding: 20px; width: 80%; max-width: 800px; max-height: 80vh; overflow-y: auto; border-radius: 10px; border: 1px solid var(--hc-blue); }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="lab-container">
        <div class="top-bar">
            <div style="font-family:'Orbitron'; font-weight:bold; color:#aaa; margin-right:20px;">HADRON LAB</div>
            <div class="status-box" style="border-color:var(--hc-green);">
                <span>ğŸ’´ BUDGET:</span><span id="disp-money" style="color:var(--hc-green); font-weight:bold;">0</span>
            </div>
            <div style="flex-grow:1;"></div>
            <div class="status-box" style="border-color:var(--hc-orange);">
                <span>RANK: </span><span id="disp-rank">Master 1</span>
            </div>
        </div>

        <div class="sidebar">
            <div class="menu-item active" onclick="showHome()">
                <div class="menu-icon">ğŸ </div> <span>HOME PORT</span>
            </div>
            <div class="menu-item" onclick="showView('view-deck')">
                <div class="menu-icon">ğŸ”„</div> <span>FORMATION</span>
            </div>
            <div class="menu-item" onclick="showView('view-shop')">
                <div class="menu-icon">ğŸ›’</div> <span>SUPPLY</span>
            </div>
            <div class="menu-item" onclick="showView('view-craft')">
                <div class="menu-icon">ğŸ› </div> <span>FACTORY</span>
            </div>
            <div class="menu-item" onclick="showView('view-proposal')">
                <div class="menu-icon">ğŸ“</div> <span>PROPOSAL</span>
            </div>
            <div class="menu-item" onclick="showView('view-office')">
                <div class="menu-icon">ğŸ“</div> <span>ARCHIVE</span>
            </div>
        </div>
        
        <div class="deck-display-area" id="home-deck-display">
            </div>

        <div id="view-home" class="main-view active">
            <div class="home-menu-container">
                <div class="gear-btn btn-main" onclick="showView('view-proposal')">
                    <div style="font-size:2.5rem;">âš¡</div><div>EXP.</div>
                </div>
                <div class="gear-btn btn-shop" onclick="showView('view-shop')">
                    <div style="font-size:1.5rem;">ğŸ›’</div><div>SUPPLY</div>
                </div>
                <div class="gear-btn btn-deck" onclick="showView('view-deck')">
                    <div style="font-size:1.5rem;">ğŸ”„</div><div>DECK</div>
                </div>
                <div class="gear-btn btn-craft" onclick="showView('view-craft')">
                    <div style="font-size:1.5rem;">ğŸ› </div><div>CRAFT</div>
                </div>
                <div class="gear-btn btn-office" onclick="showView('view-office')">
                    <div style="font-size:1.5rem;">ğŸ“‚</div><div>DATA</div>
                </div>
                <div class="gear-btn btn-battle" onclick="location.href='battle.html'">
                    <div style="font-size:1.5rem;">âš”ï¸</div><div>BATTLE</div>
                </div>
            </div>
        </div>

        <div id="view-deck" class="main-view">
            <h2 style="font-family:'Orbitron'; color:var(--hc-purple);">DECK FORMATION</h2>
            <p>æœ€å¤§5äººã®ç²’å­ã‚’é¸æŠã—ã¦ãƒãƒ¼ãƒ ã‚’ç·¨æˆã—ã¾ã™ã€‚</p>
            <div class="deck-slots" id="deck-slots-container"></div>
            <div style="text-align:center;">
                <button onclick="saveDeck()" style="padding:15px 40px; background:var(--hc-green); border:none; color:white; font-size:1.2rem; cursor:pointer;">SAVE FORMATION</button>
            </div>
        </div>

        <div id="view-shop" class="main-view"><h2 style="font-family:'Orbitron'">MATERIAL SHOP</h2><div id="shop-list" class="shop-grid"></div></div>
        <div id="view-craft" class="main-view"><h2 style="font-family:'Orbitron'">WORKSHOP</h2><div id="craft-list" class="craft-grid"></div></div>
        <div id="view-proposal" class="main-view">
            <div style="background:#eee; padding:30px; border-radius:5px; color:#333; max-width:800px; margin:0 auto;">
                <h2>Experiment Proposal</h2>
                <label>1. BEAM</label><select id="sel-beam" style="width:100%; padding:10px; margin-bottom:10px;"></select>
                <label>2. TARGET</label><select id="sel-target" style="width:100%; padding:10px; margin-bottom:10px;"></select>
                <label>3. DETECTOR</label><select id="sel-detector" style="width:100%; padding:10px; margin-bottom:10px;"></select>
                <div style="text-align:right; font-weight:bold; margin-top:20px;">COST: Â¥<span id="prop-cost">0</span></div>
                <button onclick="runExperiment()" style="width:100%; background:var(--hc-blue); color:white; padding:15px; border:none; font-size:1.2rem; margin-top:10px; cursor:pointer;">SUBMIT</button>
            </div>
        </div>
        <div id="view-office" class="main-view"><h2 style="font-family:'Orbitron'">OFFICE</h2><div id="particle-stock-list" class="shop-grid"></div></div>

    </div>

    <div id="select-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>SELECT PARTICLE</h3>
            <div id="select-list" class="particle-list"></div>
            <button onclick="closeModal()" style="margin-top:20px; padding:10px; background:#555; color:white; border:none; cursor:pointer;">CANCEL</button>
        </div>
    </div>

    <div id="result-modal" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h2 style="color:var(--hc-green);">Experiment Result</h2>
            <div id="exp-result-content"></div>
            <button onclick="document.getElementById('result-modal').style.display='none'" style="margin-top:20px; padding:10px 30px; background:var(--hc-blue); border:none; color:white; cursor:pointer;">OK</button>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // === DATA ===
        const particles = [
            { id: 1, name: "Muon", rarity: 1, image: "images/proton.png" },
            { id: 2, name: "Electron", rarity: 1, image: "images/proton.png" },
            { id: 3, name: "Proton", rarity: 1, image: "images/proton.png" },
            { id: 4, name: "Pion", rarity: 2, image: "images/pion.png" },
            { id: 5, name: "Kaon", rarity: 3, image: "images/kaon.png" },
            { id: 6, name: "J/psi", rarity: 4, image: "images/j-psi.png" },
            { id: 7, name: "Higgs", rarity: 5, image: "images/higgs.png" },
            { id: 8, name: "Top Quark", rarity: 5, image: "images/top-quark.png" }
        ];
        const materials = [
            { id: 'm1', name: 'Dry Ice', cost: 500 }, { id: 'm2', name: 'Alcohol', cost: 300 },
            { id: 'm3', name: 'PMT', cost: 5000 }, { id: 'm4', name: 'Scintillator', cost: 3000 },
            { id: 'm5', name: 'Fiber', cost: 2000 }, { id: 'm6', name: 'MPPC', cost: 8000 }
        ];
        const detectors = [
            { id: 'd1', name: 'Cloud Chamber', req: {m1:1}, power: 1 },
            { id: 'd2', name: 'Scinti Counter', req: {m3:1}, power: 3 },
            { id: 'd3', name: 'Fiber Tracker', req: {m6:5}, power: 8 }
        ];
        const beams = [{id:'b1',name:'Cosmic',cost:0,power:1}, {id:'b2',name:'RI',cost:5000,power:3}];
        const targets = [{id:'t1',name:'Air',cost:0,power:1}, {id:'t2',name:'Gold',cost:10000,power:2}];

        let user = { 
            money: 10000, invMat: {}, invDet: [], invPart: {3:1}, // ãƒ—ãƒ­ãƒˆãƒ³1å€‹æ‰€æŒ
            deck: [3, null, null, null, null] // åˆæœŸãƒ‡ãƒƒã‚­
        };

        let currentSlotIndex = 0;

        window.onload = function() {
            loadGame();
            refreshUI();
            renderDeckHome();
            renderDeckEdit();
            initProposalForm();
        };

        function showHome() {
            document.querySelectorAll('.main-view').forEach(el=>el.classList.remove('active'));
            document.getElementById('view-home').classList.add('active');
        }
        function showView(id) {
            document.querySelectorAll('.main-view').forEach(el=>el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function refreshUI() {
            document.getElementById('disp-money').innerText = user.money.toLocaleString();
            renderShop(); renderCraft(); renderOffice();
        }

        // --- DECK LOGIC (ä¿®æ­£ç‰ˆ) ---
        function renderDeckHome() {
            const el = document.getElementById('home-deck-display');
            el.innerHTML = '';
            
            // ãƒ‡ãƒƒã‚­ã‚’é€†é †ã«å‡¦ç†ã—ã¦ã€æ‰‹å‰ï¼ˆindex 0ï¼‰ãŒæœ€å¾Œã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
            // ã§ã¯ãªãã€å³ç«¯ã«å¯„ã›ã‚‹ãªã‚‰ã€index 0ã‚’ä¸€ç•ªå³ï¼ˆä¸€ç•ªä¸Šï¼‰ã«ã—ãŸã„ã€‚
            // CSSã®é‡ãªã‚Šé †ã¯å¾Œã‹ã‚‰è¿½åŠ ã—ãŸã‚‚ã®ãŒä¸Šã«ãªã‚‹ã€‚
            // ãªã®ã§ã€index 4 (å¾Œã‚) -> index 0 (æ——è‰¦ãƒ»æ‰‹å‰) ã®é †ã§è¿½åŠ ã€‚
            
            const reverseDeck = [...user.deck].reverse(); 
            // ã—ã‹ã—CSSã®Flexbox (justify-content: flex-end) ãªã®ã§ã€
            // DOMé †åº: [Member 1] [Member 2] ... [Member 5 (Flagship?)] 
            // ã„ã‚„ã€é€šå¸¸ã¯å·¦ã‹ã‚‰1ç•ªè‰¦ã€‚
            // ç”»é¢å³å´ã«é…ç½®ã—ãŸã„ã®ã§ã€å·¦ã‹ã‚‰ 5ç•ªè‰¦, 4ç•ªè‰¦ ... 1ç•ªè‰¦ ã¨ä¸¦ã¹ã‚Œã°ã€1ç•ªè‰¦ãŒä¸€ç•ªå³ã«æ¥ã‚‹ã€‚
            
            // é…åˆ—ã‚’ãã®ã¾ã¾å›ã™ (0:æ——è‰¦ -> 4:éšä¼´)
            user.deck.forEach((pid, index) => {
                if(pid) {
                    const p = particles.find(x => x.id === pid);
                    const img = document.createElement('img');
                    img.src = p.image;
                    // ã‚¯ãƒ©ã‚¹ä»˜ä¸
                    img.className = 'deck-member' + (index === 0 ? ' flagship' : '');
                    // z-indexèª¿æ•´: è‹¥ã„ç•ªå·ã»ã©æ‰‹å‰(å¤§ãã)ã—ãŸã„
                    img.style.zIndex = 50 - index; 
                    img.onclick = () => alert(`${p.name}: å‡ºæ’ƒæº–å‚™å®Œäº†ï¼`);
                    el.appendChild(img);
                }
            });
        }

        function renderDeckEdit() {
            const el = document.getElementById('deck-slots-container');
            el.innerHTML = '';
            for(let i=0; i<5; i++) {
                const pid = user.deck[i];
                const p = pid ? particles.find(x => x.id === pid) : null;
                
                let content = `<div style="font-size:2rem; color:#555;">+</div><div style="color:#aaa;">EMPTY</div>`;
                if(p) {
                    content = `<img src="${p.image}"><div class="slot-label">${p.name}</div><div class="slot-remove" onclick="removeMember(${i}, event)">Ã—</div>`;
                }

                const div = document.createElement('div');
                div.className = 'slot-card';
                div.innerHTML = content;
                div.onclick = (e) => { if(!e.target.classList.contains('slot-remove')) openSelectModal(i); };
                el.appendChild(div);
            }
        }

        function removeMember(index, e) {
            e.stopPropagation();
            user.deck[index] = null;
            renderDeckEdit();
            renderDeckHome();
            saveGame();
        }

        function openSelectModal(slotIndex) {
            currentSlotIndex = slotIndex;
            const list = document.getElementById('select-list');
            list.innerHTML = '';
            
            let hasAny = false;
            Object.keys(user.invPart).forEach(pidStr => {
                const pid = parseInt(pidStr);
                if(user.invPart[pid] > 0) {
                    hasAny = true;
                    const p = particles.find(x => x.id === pid);
                    const div = document.createElement('div');
                    div.className = 'item-card';
                    div.innerHTML = `<img src="${p.image}" style="width:50px"><br>${p.name}`;
                    div.onclick = () => {
                        user.deck[currentSlotIndex] = pid;
                        closeModal();
                        renderDeckEdit();
                        renderDeckHome();
                        saveGame();
                    };
                    list.appendChild(div);
                }
            });
            if(!hasAny) list.innerHTML = '<p>æ‰€æŒã—ã¦ã„ã‚‹ç²’å­ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            document.getElementById('select-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('select-modal').style.display = 'none'; }
        function saveDeck() { saveGame(); alert("ç·¨æˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼"); }

        // --- Other Logic ---
        function renderShop() {
            const el=document.getElementById('shop-list'); el.innerHTML='';
            materials.forEach(m=>{
                el.innerHTML+=`<div class="item-card" onclick="buy('${m.id}')"><div>${m.name}</div><div style="color:var(--hc-green)">Â¥${m.cost}</div></div>`
            });
        }
        function buy(id) {
            const m=materials.find(x=>x.id==id);
            if(user.money>=m.cost){user.money-=m.cost; user.invMat[id]=(user.invMat[id]||0)+1; saveGame(); refreshUI();}
        }
        function renderCraft() {
            const el=document.getElementById('craft-list'); el.innerHTML='';
            detectors.forEach(d=>{
                const own=user.invDet.includes(d.id);
                el.innerHTML+=`<div class="item-card" onclick="craft('${d.id}')"><div>${d.name}</div><div>${own?'OWNED':'CRAFT'}</div></div>`;
            });
        }
        function craft(id){
            if(user.invDet.includes(id))return;
            user.invDet.push(id); saveGame(); refreshUI();
        }
        function initProposalForm() {
            const b=document.getElementById('sel-beam'), t=document.getElementById('sel-target'), d=document.getElementById('sel-detector');
            b.innerHTML=beams.map(x=>`<option value="${x.id}">${x.name} Â¥${x.cost}</option>`).join('');
            t.innerHTML=targets.map(x=>`<option value="${x.id}">${x.name} Â¥${x.cost}</option>`).join('');
            d.innerHTML=user.invDet.map(id=>`<option value="${id}">${detectors.find(x=>x.id==id).name}</option>`).join('');
            calcProposalCost();
        }
        function calcProposalCost(){
            const b=beams.find(x=>x.id==document.getElementById('sel-beam').value);
            const t=targets.find(x=>x.id==document.getElementById('sel-target').value);
            if(b&&t) document.getElementById('prop-cost').innerText = (b.cost+t.cost).toLocaleString();
        }
        function runExperiment(){
            const b=beams.find(x=>x.id==document.getElementById('sel-beam').value);
            const t=targets.find(x=>x.id==document.getElementById('sel-target').value);
            if(user.money < b.cost+t.cost){alert("è³‡é‡‘ä¸è¶³");return;}
            user.money -= (b.cost+t.cost);
            const p = particles[Math.floor(Math.random()*particles.length)];
            user.invPart[p.id] = (user.invPart[p.id]||0)+1;
            saveGame(); refreshUI();
            document.getElementById('exp-result-content').innerHTML = `GET: ${p.name}`;
            document.getElementById('result-modal').style.display='block';
        }
        function renderOffice(){
            const el=document.getElementById('particle-stock-list'); el.innerHTML='';
            Object.keys(user.invPart).forEach(pid=>{
                if(user.invPart[pid]>0) {
                    const p=particles.find(x=>x.id==pid);
                    el.innerHTML+=`<div class="item-card" onclick="sell(${pid})">${p.name} x${user.invPart[pid]}<br>PUBLISH</div>`;
                }
            });
        }
        function sell(pid){
            if(user.invPart[pid]>0){user.invPart[pid]--; user.money+=1000; saveGame(); refreshUI();}
        }

        function saveGame() { localStorage.setItem('hadron_v8', JSON.stringify(user)); }
        function loadGame() {
            const d=localStorage.getItem('hadron_v8'); if(d) user=JSON.parse(d);
            if(!user.deck) user.deck=[3,null,null,null,null];
        }
    </script>
</body>
</html>
