<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Hadron Lab Ver 5.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=M+PLUS+Rounded+1c:wght@700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* ===== Hadron Lab 5.0 System UI ===== */
        :root {
            --hc-dark: #1a1c23;
            --hc-panel: rgba(20, 25, 40, 0.9);
            --hc-orange: #f39c12;
            --hc-red: #e74c3c;
            --hc-blue: #3498db;
            --hc-green: #2ecc71;
            --hc-purple: #9b59b6;
            --hc-glow: #00f3ff;
            --hc-ultra: #ff3333;
        }

        body { margin: 0; background: #000; color: white; font-family: 'M PLUS Rounded 1c', sans-serif; overflow: hidden; user-select: none; }

        /* èƒŒæ™¯ */
        .lab-container {
            width: 100vw; height: 100vh; position: relative;
            background-image: url('images/lab_bg.png'); 
            background-size: cover; background-position: center; background-color: #0a0e14;
        }

        /* ä¸Šéƒ¨ãƒãƒ¼ï¼ˆè³‡æºï¼‰ */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 70px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent);
            display: flex; align-items: center; padding: 0 20px; box-sizing: border-box; z-index: 10; gap: 15px;
        }
        .res-box {
            display: flex; align-items: center; background: rgba(0,0,0,0.6); 
            border: 1px solid #444; border-radius: 5px; padding: 5px 15px; min-width: 120px;
        }
        .res-icon { font-size: 1.2rem; margin-right: 8px; }
        .res-val { font-family: 'Orbitron', sans-serif; font-size: 1.1rem; color: var(--hc-glow); }
        .res-label { font-size: 0.7rem; color: #aaa; margin-bottom: 2px; }

        /* å·¦ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .menu-area {
            position: absolute; left: 30px; top: 100px; bottom: 30px; width: 320px;
            display: flex; flex-direction: column; gap: 15px; z-index: 20;
        }

        .menu-btn {
            height: 65px; background: rgba(30, 40, 60, 0.95);
            border-left: 5px solid #555; border-radius: 0 10px 10px 0;
            display: flex; align-items: center; padding-left: 20px;
            font-family: 'Orbitron', sans-serif; font-size: 1.1rem; cursor: pointer;
            transition: all 0.2s; color: #ddd; border-top: 1px solid #333; border-bottom: 1px solid #333;
        }
        .menu-btn:hover { transform: translateX(10px); color: white; text-shadow: 0 0 10px white; }
        
        .btn-gacha { border-color: var(--hc-orange); }
        .btn-craft { border-color: var(--hc-blue); }
        .btn-exp { border-color: var(--hc-purple); }
        .btn-list { border-color: var(--hc-green); }

        /* å‡ºæ’ƒãƒœã‚¿ãƒ³ */
        .btn-sortie {
            width: 100%; height: 80px; margin-bottom: 20px;
            background: linear-gradient(90deg, #c0392b, #8e44ad);
            border: 2px solid #ff9999; border-radius: 10px;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            cursor: pointer; transition: transform 0.2s; box-shadow: 0 0 20px rgba(231, 76, 60, 0.5);
        }
        .btn-sortie:hover { transform: scale(1.05); filter: brightness(1.2); }

        /* å³å´ï¼šç§˜æ›¸ç²’å­ã‚¨ãƒªã‚¢ */
        .secretary-area {
            position: absolute; right: 0; bottom: 0; height: 90vh; width: 55vw;
            pointer-events: none; display: flex; align-items: flex-end; justify-content: flex-end;
        }
        .secretary-img {
            max-height: 95%; max-width: 95%; object-fit: contain;
            filter: drop-shadow(0 0 30px rgba(0,0,0,0.8));
            pointer-events: auto; cursor: help; transition: transform 0.1s;
        }
        
        .bubble {
            position: absolute; right: 30%; top: 30%;
            background: rgba(255,255,255,0.95); color: #333; padding: 20px; border-radius: 20px;
            max-width: 300px; font-weight: bold; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            display: none; animation: popIn 0.3s; z-index: 15; font-size: 0.9rem;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            z-index: 100; display: none; justify-content: center; align-items: center;
        }
        .modal-window {
            width: 900px; max-height: 85vh; background: #151515;
            border: 1px solid #444; border-radius: 10px;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .modal-header {
            padding: 15px 20px; background: #222; border-bottom: 1px solid #444;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-family: 'Orbitron'; font-size: 1.5rem; color: white; }
        .close-btn { font-size: 2rem; cursor: pointer; color: #888; }
        .modal-body { padding: 20px; overflow-y: auto; color: #ccc; }

        /* ç´ æã‚¬ãƒãƒ£ç”»é¢ */
        .gacha-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px; }
        .mat-item {
            background: #252525; border: 1px solid #444; padding: 10px; border-radius: 5px;
            text-align: center; display: flex; flex-direction: column; align-items: center;
        }
        .mat-icon { font-size: 2rem; margin-bottom: 5px; }
        
        /* ã‚¯ãƒ©ãƒ•ãƒˆç”»é¢ */
        .craft-list { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .craft-card {
            background: #222; border: 1px solid #444; padding: 15px; border-radius: 5px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .craft-info h4 { margin: 0 0 5px 0; color: var(--hc-blue); }
        .craft-cost { font-size: 0.8rem; color: #aaa; }
        .btn-do-craft {
            padding: 8px 15px; background: var(--hc-blue); border: none; color: white;
            cursor: pointer; border-radius: 4px; font-weight: bold;
        }
        .btn-do-craft:disabled { background: #444; cursor: not-allowed; }

        /* å®Ÿé¨“ç”»é¢ */
        .exp-setup { display: flex; justify-content: space-around; margin-bottom: 30px; }
        .slot-box {
            width: 40%; background: #222; border: 2px dashed #555; padding: 20px;
            text-align: center; cursor: pointer; border-radius: 10px;
        }
        .slot-box.selected { border-style: solid; border-color: var(--hc-green); background: #1a2a1a; }
        .exp-result { text-align: center; min-height: 200px; display: flex; justify-content: center; align-items: center; }

        /* ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ & å‡ºæ’ƒç·¨æˆ */
        .particle-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .p-card {
            background: #2a2d35; border: 1px solid #555; border-radius: 5px; height: 110px;
            position: relative; cursor: pointer; overflow: hidden; transition: 0.2s;
        }
        .p-card.selected { border-color: var(--hc-green); box-shadow: 0 0 15px var(--hc-green); }
        .p-card img { width: 100%; height: 60px; object-fit: cover; opacity: 0.5; }
        .p-card.owned img { opacity: 1; }
        .p-lvl { position: absolute; bottom: 2px; right: 5px; font-size: 0.8rem; font-weight: bold; color: var(--hc-orange); }
        .p-name { position: absolute; top: 2px; left: 5px; font-weight: bold; text-shadow: 0 1px 2px black; font-size: 0.9rem;}

        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div class="lab-container">
        <div class="top-bar">
            <div class="res-box">
                <span class="res-icon">ğŸ’°</span>
                <div>
                    <div class="res-label">BUDGET</div>
                    <div class="res-val">Â¥<span id="disp-money">0</span></div>
                </div>
            </div>
            <div class="res-box" style="flex-grow:1; justify-content: flex-start;">
                <span class="res-icon">ğŸ“¦</span>
                <div id="disp-materials" style="font-size:0.8rem; display:flex; gap:15px; color:#ddd;">
                    </div>
            </div>
        </div>

        <div class="menu-area">
            <div class="btn-sortie" onclick="location.href='battle.html'">
                <div style="font-family:'Orbitron'; font-size:1.8rem; font-weight:bold;">SORTIE</div>
                <div style="font-size:0.8rem;">å‡ºæ’ƒ (BOSS BATTLE)</div>
            </div>

            <div class="menu-btn btn-gacha" onclick="openModal('modal-gacha')">
                <span>ğŸ”© MATERIAL GACHA</span>
            </div>
            <div class="menu-btn btn-craft" onclick="openModal('modal-craft')">
                <span>ğŸ›  CRAFT DETECTOR</span>
            </div>
            <div class="menu-btn btn-exp" onclick="openModal('modal-exp')">
                <span>âš—ï¸ EXPERIMENT</span>
            </div>
            <div class="menu-btn btn-list" onclick="openModal('modal-list')">
                <span>ğŸ“‚ COLLECTION</span>
            </div>
            <div class="menu-btn" onclick="changeSecretary()" style="border-color:#e74c3c;">
                <span>ğŸ”„ CHANGE SECRETARY</span>
            </div>
        </div>

        <div class="bubble" id="secretary-bubble">ç ”ç©¶è²»ãŒè¶³ã‚Šã¾ã›ã‚“...</div>
        <div class="secretary-area">
            <img id="secretary-img" class="secretary-img" src="" onclick="talkSecretary()">
        </div>
    </div>

    <div id="modal-gacha" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-header">
                <span class="modal-title">MATERIAL SUPPLY (GACHA)</span>
                <span class="close-btn" onclick="closeModal('modal-gacha')">Ã—</span>
            </div>
            <div class="modal-body" style="text-align:center;">
                <p>äºˆç®—ã‚’ä½¿ã£ã¦å®Ÿé¨“ç”¨ç´ æã‚’èª¿é”ã—ã¾ã™ã€‚</p>
                <button onclick="runMaterialGacha(10)" style="padding:15px 40px; background:var(--hc-orange); border:none; border-radius:5px; font-size:1.2rem; font-weight:bold; cursor:pointer;">
                    ORDER 10 (Â¥3,000)
                </button>
                <div id="gacha-result" class="gacha-grid"></div>
            </div>
        </div>
    </div>

    <div id="modal-craft" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-header">
                <span class="modal-title">EQUIPMENT CRAFTING</span>
                <span class="close-btn" onclick="closeModal('modal-craft')">Ã—</span>
            </div>
            <div class="modal-body">
                <h3>ACCELERATORS</h3>
                <div id="craft-list-acc" class="craft-list" style="margin-bottom:20px;"></div>
                <h3>DETECTORS</h3>
                <div id="craft-list-det" class="craft-list"></div>
            </div>
        </div>
    </div>

    <div id="modal-exp" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-header">
                <span class="modal-title">PHYSICS EXPERIMENT</span>
                <span class="close-btn" onclick="closeModal('modal-exp')">Ã—</span>
            </div>
            <div class="modal-body">
                <div style="text-align:center; margin-bottom:20px;">
                    <p>åŠ é€Ÿå™¨ã¨æ¤œå‡ºå™¨ã‚’ã‚»ãƒƒãƒˆã—ã¦å®Ÿé¨“ã‚’è¡Œã„ã¾ã™ã€‚ç¢ºç‡ã§ç²’å­ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚</p>
                    <div style="color:var(--hc-red); font-weight:bold; font-size:1.2rem;">COST: Â¥10,000</div>
                </div>

                <div class="exp-setup">
                    <div id="slot-acc" class="slot-box" onclick="selectEquip('acc')">
                        <div style="font-size:2rem;">âš¡</div>
                        <div id="sel-acc-name">Select Accelerator</div>
                    </div>
                    <div style="display:flex; align-items:center; font-size:2rem;">+</div>
                    <div id="slot-det" class="slot-box" onclick="selectEquip('det')">
                        <div style="font-size:2rem;">ğŸ“¡</div>
                        <div id="sel-det-name">Select Detector</div>
                    </div>
                </div>

                <div style="text-align:center;">
                    <button id="btn-run-exp" onclick="runExperiment()" disabled style="padding:15px 50px; background:var(--hc-purple); border:none; border-radius:5px; font-size:1.5rem; font-weight:bold; color:white; cursor:pointer; opacity:0.5;">
                        START EXPERIMENT
                    </button>
                </div>

                <div id="exp-result" class="exp-result">
                    </div>
            </div>
        </div>
    </div>

    <div id="modal-list" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-header">
                <span class="modal-title">PARTICLE ARCHIVE</span>
                <span class="close-btn" onclick="closeModal('modal-list')">Ã—</span>
            </div>
            <div class="modal-body">
                <div id="collection-view" class="particle-list"></div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // === ãƒ‡ãƒ¼ã‚¿å®šç¾© ===

        // ç²’å­ãƒ‡ãƒ¼ã‚¿
        const particleDB = [
            { id: 1, name: "Proton", symbol: "p", rarity: 1, image: "images/proton.png", desc: "ç‰©è³ªã®åŸºç¤ã€‚" },
            { id: 2, name: "Neutron", symbol: "n", rarity: 1, image: "images/neutron.png", desc: "ä¸­æ€§å­ã€‚" },
            { id: 3, name: "Pion", symbol: "Ï€", rarity: 1, image: "images/pion.png", desc: "æ¹¯å·ç²’å­ã€‚" },
            { id: 4, name: "Kaon", symbol: "K", rarity: 2, image: "images/kaon.png", desc: "ã‚¹ãƒˆãƒ¬ãƒ³ã‚¸ã€‚" },
            { id: 5, name: "Lambda", symbol: "Î›", rarity: 2, image: "images/lambda.png", desc: "ãƒã‚¤ãƒ‘ãƒ¼æ ¸ã®ä¸»å½¹ã€‚" },
            { id: 6, name: "Sigma", symbol: "Î£", rarity: 2, image: "images/sigma.png", desc: "ã‚·ã‚°ãƒã€‚" },
            { id: 7, name: "Xi", symbol: "Î", rarity: 3, image: "images/xi.png", desc: "ã‚¹ãƒˆãƒ¬ãƒ³ã‚¸-2ã€‚" },
            { id: 8, name: "Omega", symbol: "Î©", rarity: 3, image: "images/omega.png", desc: "ç‹è€…ã®é¢¨æ ¼ã€‚" },
            { id: 9, name: "J/psi", symbol: "J/Ïˆ", rarity: 4, image: "images/j-psi.png", desc: "ãƒãƒ£ãƒ¼ãƒ ã€‚" },
            { id: 10, name: "Higgs", symbol: "H", rarity: 5, image: "images/higgs.png", desc: "ç¥ã®ç²’å­ã€‚" }
        ];

        // ç´ æãƒ‡ãƒ¼ã‚¿
        const materialDB = {
            m1: { name: "Alumium", icon: "ğŸ”©", rarity: 1 },
            m2: { name: "Cable", icon: "â°", rarity: 1 },
            m3: { name: "Scintillator", icon: "âœ¨", rarity: 2 },
            m4: { name: "PMT", icon: "ğŸ’¡", rarity: 2 },
            m5: { name: "FPGA", icon: "ğŸ’¾", rarity: 3 },
            m6: { name: "SuperCon", icon: "â„ï¸", rarity: 4 }
        };

        // è£…ç½®ãƒ‡ãƒ¼ã‚¿ (ãƒ¬ã‚·ãƒ”ã¨æ€§èƒ½)
        const equipmentDB = [
            // åŠ é€Ÿå™¨ (Power: ãƒ¬ã‚¢ç²’å­å‡ºç¾ç‡è£œæ­£)
            { id: "acc1", type: "acc", name: "Synchrotron (Low)", power: 10, req: { m1: 5, m2: 5 } },
            { id: "acc2", type: "acc", name: "Cyclotron (Mid)", power: 30, req: { m1: 10, m2: 10, m6: 2 } },
            { id: "acc3", type: "acc", name: "LHC (High)", power: 80, req: { m1: 20, m6: 10, m5: 5 } },
            // æ¤œå‡ºå™¨ (Sens: æˆåŠŸç‡è£œæ­£)
            { id: "det1", type: "det", name: "Scintillator Counter", sens: 20, req: { m3: 5, m4: 2 } },
            { id: "det2", type: "det", name: "Drift Chamber", sens: 50, req: { m2: 10, m5: 5 } },
            { id: "det3", type: "det", name: "Hyper Detector", sens: 90, req: { m3: 20, m4: 10, m5: 10 } }
        ];

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿åˆæœŸå€¤
        let userData = {
            money: 50000,
            materials: { m1:0, m2:0, m3:0, m4:0, m5:0, m6:0 },
            equipments: [], // æ‰€æŒã—ã¦ã„ã‚‹è£…ç½®IDãƒªã‚¹ãƒˆ
            particles: {}, // { id: { level: 1, count: 1 } }
            secretary: 1
        };

        // ä¸€æ™‚çŠ¶æ…‹
        let selectedAcc = null;
        let selectedDet = null;

        // === ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ===

        window.onload = function() {
            loadGame();
            updateUI();
            setSecretaryDisplay();
        };

        function updateUI() {
            document.getElementById('disp-money').innerText = userData.money.toLocaleString();
            
            // ç´ æè¡¨ç¤º
            const matArea = document.getElementById('disp-materials');
            matArea.innerHTML = "";
            for(let key in materialDB) {
                if(userData.materials[key] > 0) {
                    matArea.innerHTML += `<div>${materialDB[key].icon} ${userData.materials[key]}</div>`;
                }
            }

            renderCraftList();
            renderCollection();
        }

        // 1. ç´ æã‚¬ãƒãƒ£
        function runMaterialGacha(count) {
            const cost = 3000;
            if(userData.money < cost) { alert("äºˆç®—ä¸è¶³ï¼"); return; }
            userData.money -= cost;

            const resDiv = document.getElementById('gacha-result');
            resDiv.innerHTML = "";
            const matKeys = Object.keys(materialDB);

            for(let i=0; i<count; i++) {
                // ç¢ºç‡: ä½ãƒ¬ã‚¢ãŒå‡ºã‚„ã™ã„
                const r = Math.random();
                let pick = matKeys[0];
                if(r > 0.95) pick = "m6"; // è¶…é›»å°
                else if(r > 0.85) pick = "m5";
                else if(r > 0.70) pick = "m4";
                else if(r > 0.55) pick = "m3";
                else if(r > 0.30) pick = "m2";
                else pick = "m1";

                userData.materials[pick]++;
                
                // è¡¨ç¤º
                const m = materialDB[pick];
                resDiv.innerHTML += `
                    <div class="mat-item" style="border-color:${getColor(m.rarity)}">
                        <div class="mat-icon">${m.icon}</div>
                        <div style="font-size:0.8rem;">${m.name}</div>
                    </div>
                `;
            }
            saveGame();
            updateUI();
        }

        // 2. ã‚¯ãƒ©ãƒ•ãƒˆ
        function renderCraftList() {
            const listAcc = document.getElementById('craft-list-acc');
            const listDet = document.getElementById('craft-list-det');
            listAcc.innerHTML = ""; listDet.innerHTML = "";

            equipmentDB.forEach(eq => {
                const isOwned = userData.equipments.includes(eq.id);
                // ã‚³ã‚¹ãƒˆæ–‡å­—åˆ—ä½œæˆ
                let reqStr = "";
                let canCraft = true;
                for(let mKey in eq.req) {
                    const need = eq.req[mKey];
                    const have = userData.materials[mKey];
                    if(have < need) canCraft = false;
                    reqStr += `${materialDB[mKey].icon}${need} `;
                }

                const html = `
                    <div class="craft-card">
                        <div class="craft-info">
                            <h4>${eq.name}</h4>
                            <div class="craft-cost">${reqStr}</div>
                        </div>
                        <button class="btn-do-craft" onclick="craftItem('${eq.id}')" 
                            ${(canCraft && !isOwned) ? "" : "disabled"}>
                            ${isOwned ? "OWNED" : "CRAFT"}
                        </button>
                    </div>
                `;
                if(eq.type === 'acc') listAcc.innerHTML += html;
                else listDet.innerHTML += html;
            });
        }

        function craftItem(eqId) {
            const eq = equipmentDB.find(e => e.id === eqId);
            // ç´ ææ¶ˆè²»
            for(let mKey in eq.req) {
                userData.materials[mKey] -= eq.req[mKey];
            }
            userData.equipments.push(eqId);
            alert(`${eq.name} ã®é–‹ç™ºã«æˆåŠŸã—ã¾ã—ãŸï¼`);
            saveGame();
            updateUI();
        }

        // 3. å®Ÿé¨“
        function selectEquip(type) {
            // æ‰€æŒã—ã¦ã„ã‚‹è©²å½“ã‚¿ã‚¤ãƒ—ã®è£…å‚™ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã—ã¦é¸ã°ã›ã‚‹ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
            const owned = equipmentDB.filter(e => e.type === type && userData.equipments.includes(e.id));
            if(owned.length === 0) { alert("è£…ç½®ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚CRAFTã§ä½œã£ã¦ãã ã•ã„ã€‚"); return; }
            
            // ç°¡æ˜“çš„ã«åå‰ãƒªã‚¹ãƒˆã‚’å‡ºã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§é¸ã°ã›ã‚‹ï¼ˆæœ¬æ¥ã¯å°‚ç”¨UIæ¨å¥¨ï¼‰
            let msg = "IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:\n";
            owned.forEach((e, idx) => msg += `${idx}: ${e.name}\n`);
            const input = prompt(msg, "0");
            if(input !== null && owned[input]) {
                if(type === 'acc') {
                    selectedAcc = owned[input];
                    document.getElementById('sel-acc-name').innerText = selectedAcc.name;
                    document.getElementById('slot-acc').classList.add('selected');
                } else {
                    selectedDet = owned[input];
                    document.getElementById('sel-det-name').innerText = selectedDet.name;
                    document.getElementById('slot-det').classList.add('selected');
                }
            }
            
            // ä¸¡æ–¹æƒã£ãŸã‚‰ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
            const btn = document.getElementById('btn-run-exp');
            if(selectedAcc && selectedDet) {
                btn.disabled = false;
                btn.style.opacity = 1;
            }
        }

        function runExperiment() {
            const cost = 10000;
            if(userData.money < cost) { alert("å®Ÿé¨“äºˆç®—(Â¥10,000)ãŒè¶³ã‚Šã¾ã›ã‚“ï¼"); return; }
            userData.money -= cost;

            const resArea = document.getElementById('exp-result');
            resArea.innerHTML = "<h3>EXPERIMENTING...</h3>";

            setTimeout(() => {
                // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨ˆç®—
                // Power: ãƒ¬ã‚¢åº¦æŠ½é¸å€¤ã«åŠ ç®—
                // Sens: æˆåŠŸç‡ï¼ˆã‚´ãƒŸã«ãªã‚‰ãªã„ç¢ºç‡ï¼‰
                const power = selectedAcc.power; 
                const sens = selectedDet.sens;

                // æˆåŠŸåˆ¤å®š
                if(Math.random() * 100 > sens + 10) {
                    resArea.innerHTML = "<h2 style='color:gray;'>FAILURE...</h2><p>ãƒã‚¤ã‚ºã—ã‹è¦³æ¸¬ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
                    saveGame();
                    updateUI();
                    return;
                }

                // ç²’å­æŠ½é¸
                let rand = Math.random() * 100;
                // PowerãŒé«˜ã„ã»ã©randã‚’æ¸›ã‚‰ã™ï¼ˆé«˜ãƒ¬ã‚¢ãŒå‡ºã‚„ã™ãã™ã‚‹ï¼‰
                rand -= power;

                let rarity = 1;
                if(rand < 0) rarity = 5; // Higgs
                else if(rand < 20) rarity = 4;
                else if(rand < 50) rarity = 3;
                else if(rand < 80) rarity = 2;
                else rarity = 1;

                const candidates = particleDB.filter(p => p.rarity === rarity);
                const p = candidates[Math.floor(Math.random() * candidates.length)];

                // ç²å¾—å‡¦ç†
                if(!userData.particles[p.id]) {
                    userData.particles[p.id] = { level: 1, count: 0 };
                }
                userData.particles[p.id].count++;

                resArea.innerHTML = `
                    <div style="animation:popIn 0.5s;">
                        <h2 style="color:${getColor(p.rarity)}">DISCOVERY!</h2>
                        <img src="${p.image}" style="width:150px;">
                        <h3>${p.name}</h3>
                        <p>${p.desc}</p>
                    </div>
                `;
                saveGame();
                updateUI();
            }, 1000);
        }

        // å…±é€š
        function getColor(rarity) {
            if(rarity==5) return "#ff3333";
            if(rarity==4) return "#f1c40f";
            if(rarity==3) return "#9b59b6";
            if(rarity==2) return "#3498db";
            return "#ccc";
        }

        function renderCollection() {
            const list = document.getElementById('collection-view');
            list.innerHTML = "";
            particleDB.forEach(p => {
                const data = userData.particles[p.id];
                const isOwned = !!data;
                list.innerHTML += `
                    <div class="p-card ${isOwned?'owned':''}" onclick="setSecretary(${p.id})">
                        <img src="${p.image}">
                        <div class="p-name" style="color:${getColor(p.rarity)}">${p.symbol}</div>
                        ${isOwned ? `<div class="p-lvl">Lv.${data.level}</div>` : ''}
                    </div>
                `;
            });
        }

        // ç§˜æ›¸ãƒ»ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰
        function setSecretary(id) {
            if(!userData.particles[id]) return;
            userData.secretary = id;
            setSecretaryDisplay();
            talkSecretary("Secretary changed.");
            saveGame();
        }

        function setSecretaryDisplay() {
            const id = userData.secretary;
            const p = particleDB.find(x => x.id === id) || particleDB[0];
            document.getElementById('secretary-img').src = p.image;
        }
        function talkSecretary(msg) {
            const bub = document.getElementById('secretary-bubble');
            bub.innerText = msg || "å®Ÿé¨“ã€ãŠç–²ã‚Œæ§˜ã§ã™ã€‚";
            bub.style.display = 'block';
            setTimeout(()=>bub.style.display='none', 3000);
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        // ç§˜æ›¸å¤‰æ›´ãƒœã‚¿ãƒ³ç”¨
        function changeSecretary() {
            const keys = Object.keys(userData.particles);
            if(keys.length === 0) return;
            const rndId = keys[Math.floor(Math.random()*keys.length)];
            setSecretary(parseInt(rndId));
        }

        function saveGame() { localStorage.setItem('hadron_lab_v5', JSON.stringify(userData)); }
        function loadGame() {
            const d = localStorage.getItem('hadron_lab_v5');
            if(d) userData = JSON.parse(d);
            // åˆæœŸè£…å‚™ãƒ»è³‡é‡‘ãŒãªã„å ´åˆã®æ•‘æ¸ˆ
            if(userData.money < 3000 && Object.keys(userData.particles).length===0) userData.money = 100000; 
        }

    </script>
</body>
</html>
