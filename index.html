<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hoge| Hadron Colle</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=M+PLUS+Rounded+1c:wght@700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* ===== ハドこれ 3.2 修正完了版 ===== */
        :root {
            --hc-dark: #1a1c23;
            --hc-panel: rgba(30, 35, 50, 0.9);
            --hc-orange: #f39c12;
            --hc-blue: #3498db;
            --hc-glow: #00f3ff;
            --hc-ultra: #e74c3c;
        }

        .hc-container {
            background-color: var(--hc-dark);
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.05) 1px, transparent 1px),
                radial-gradient(circle at 50% 50%, #000 0%, #1a1c23 100%);
            background-size: 40px 40px, 40px 40px, 100% 100%;
            color: white; padding: 20px; border-radius: 10px;
            font-family: 'M PLUS Rounded 1c', sans-serif; min-height: 750px;
            position: relative; border: 1px solid #333;
        }

        /* 資源パネル */
        .resource-panel {
            display: flex; justify-content: space-around;
            background: var(--hc-panel); backdrop-filter: blur(5px);
            padding: 15px; border-radius: 8px; margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .res-item { text-align: center; width: 30%; }
        .res-label { font-size: 0.75rem; color: #88a; text-transform: uppercase; }
        .res-val { font-size: 1.3rem; color: var(--hc-glow); font-family: 'Orbitron'; font-weight: bold; }

        /* 加速器レベル表示 */
        .accelerator-info {
            text-align: center; margin-bottom: 20px;
            font-family: 'Orbitron'; color: #aaa;
        }
        .acc-name { font-size: 1.5rem; color: var(--hc-orange); text-shadow: 0 0 10px var(--hc-orange); }

        /* ドックエリア */
        .dock-container {
            display: flex; justify-content: center; align-items: center; gap: 40px; margin-bottom: 30px; flex-wrap: wrap;
        }
        .dock-circle {
            width: 180px; height: 180px;
            border: 4px solid var(--hc-orange); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            position: relative; cursor: pointer;
            background: radial-gradient(circle, #333 0%, #111 100%);
            box-shadow: 0 0 30px rgba(243, 156, 18, 0.2);
            transition: transform 0.2s;
        }
        .dock-circle:hover { transform: scale(1.05); }
        .dock-circle:active { transform: scale(0.95); }
        .dock-text { text-align: center; z-index: 2; }

        /* ボタン群 */
        .btn-upgrade {
            background: linear-gradient(90deg, #8e44ad, #9b59b6);
            border: 1px solid #a569bd; color: white; padding: 10px 20px;
            border-radius: 5px; cursor: pointer; font-weight: bold; font-family: 'Orbitron';
            width: 100%; margin-bottom: 10px;
        }
        .btn-upgrade:disabled { background: #555; border-color:#666; cursor: not-allowed; opacity: 0.7; }

        .btn-battle {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            border: 1px solid #ec7063; color: white; padding: 15px 30px;
            border-radius: 5px; cursor: pointer; font-weight: bold; font-family: 'Orbitron';
            text-decoration: none; display: block; text-align: center;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.4); animation: pulse 2s infinite;
        }
        
        /* カード関連 */
        .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        .mini-card { background: #2a2d35; border: 1px solid #444; border-radius: 5px; height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; position: relative; }
        .mini-card.got { opacity: 1; border-color: var(--hc-orange); }
        .mini-card:not(.got) { opacity: 0.3; filter: grayscale(100%); }
        .mini-rarity-ultra { color: var(--hc-ultra); text-shadow: 0 0 5px red; font-weight: bold;}

        /* 結果表示 */
        .card-display { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; padding: 20px; box-sizing: border-box; overflow-y: auto;}
        .particle-card { width: 100%; max-width: 300px; background: white; border-radius: 10px; padding: 0; overflow: hidden; display: none; color: #333; animation: popIn 0.5s; }
        .rarity-ultra { border: 4px solid var(--hc-ultra); box-shadow: 0 0 50px var(--hc-ultra); background: linear-gradient(135deg, #fff, #ffcccc); }
        .close-btn { margin-top: 20px; padding: 10px 40px; background: var(--hc-orange); border: none; color: white; border-radius: 20px; cursor: pointer; font-size: 1.2rem; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
    <div class="site-container">
        <aside class="sidebar" id="sidebar"></aside>

        <main class="main-content">
            <h1 class="game-title" style="text-align:center; font-family:'Orbitron'; margin-bottom:10px;">HADRON COLLECTION</h1>
            
            <div class="hc-container">
                <div class="resource-panel">
                    <div class="res-item">
                        <div class="res-label">BUDGET (¥)</div>
                        <div class="res-val" id="res-budget">0</div>
                    </div>
                    <div class="res-item">
                        <div class="res-label">BEAM</div>
                        <div class="res-val">STABLE</div>
                    </div>
                </div>

                <div class="accelerator-info">
                    Current Accelerator: <br>
                    <span class="acc-name" id="acc-name">30 GeV Synchrotron</span>
                </div>

                <div class="dock-container">
                    <div class="dock-circle" onclick="tryGacha(1)">
                        <div class="dock-text">
                            <div style="font-size:1.5rem; font-weight:bold; color:white;">BUILD</div>
                            <div style="font-size:0.9rem; color:var(--hc-orange);">Cost: ¥300</div>
                        </div>
                    </div>

                    <div style="width:200px;">
                        <button class="btn-upgrade" id="btn-upgrade" onclick="upgradeAccelerator()">
                            UPGRADE <br><span style="font-size:0.7rem;" id="upgrade-cost">Cost: ¥2000</span>
                        </button>
                        <a href="battle.html" class="btn-battle">
                            BATTLE SORTIE<br><span style="font-size:0.7rem;">(Earn Budget)</span>
                        </a>
                    </div>
                </div>

                <p id="status-msg" style="text-align:center; color:#aaa; font-size:0.9rem;">Win battles to earn research budget!</p>

                <div class="collection-section" style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px;">
                    <h3 style="margin-top:0; border-bottom:1px solid #444;">Archive</h3>
                    <div class="collection-grid" id="collection-list"></div>
                </div>
            </div>

            <div class="card-display" id="result-overlay">
                <div class="particle-card" id="single-result">
                    <img id="card-img" src="" style="width:100%; height:200px; object-fit:cover;">
                    <div style="padding:15px;">
                        <h2 id="card-name" style="margin:0;">Name</h2>
                        <div id="card-rarity" style="color:#888; font-size:0.8rem; margin-bottom:10px;">RARITY</div>
                        <p id="card-desc" style="font-size:0.9rem; background:#f9f9f9; padding:10px; border-radius:5px;"></p>
                    </div>
                </div>
                <button class="close-btn" onclick="closeResult()">CONFIRM</button>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
        // ★★★ データ修正ポイント：ID 13, 14 が必ずあることを確認！ ★★★
        const particleDB = [
            { id: 1, name: "Proton", symbol: "p", rarity: "common", mass: "938", image: "images/proton.png", desc: "物質の基礎。安定志向。" },
            { id: 2, name: "Neutron", symbol: "n", rarity: "common", mass: "939", image: "images/neutron.png", desc: "中性子。単体だと不安定。" },
            { id: 3, name: "Pion (+)", symbol: "π⁺", rarity: "common", mass: "140", image: "images/pion.png", desc: "湯川博士の予言粒子。" },
            { id: 4, name: "Kaon (+)", symbol: "K⁺", rarity: "rare", mass: "493", image: "images/kaon.png", desc: "ストレンジネスを持つ。" },
            { id: 5, name: "Lambda", symbol: "Λ", rarity: "rare", mass: "1115", image: "images/lambda.png", desc: "ハイパー核の主役。" },
            { id: 6, name: "Sigma (-)", symbol: "Σ⁻", rarity: "rare", mass: "1197", image: "images/sigma.png", desc: "中性子過剰環境で発見。" },
            { id: 7, name: "Xi (-)", symbol: "Ξ⁻", rarity: "holo", mass: "1321", image: "images/xi.png", desc: "ストレンジネス-2。" },
            { id: 8, name: "H-Dibaryon", symbol: "H", rarity: "holo", mass: "2200", image: "images/h_dibaryon.png", desc: "幻の6クォーク状態。" },
            { id: 9, name: "Delta (++)", symbol: "Δ⁺⁺", rarity: "common", mass: "1232", image: "images/delta.png", desc: "陽子の励起状態。" },
            { id: 10, name: "Omega (-)", symbol: "Ω⁻", rarity: "holo", mass: "1672", image: "images/omega.png", desc: "ストレンジネス-3の王者。" },
            { id: 11, name: "D Meson", symbol: "D⁰", rarity: "rare", mass: "1865", image: "images/d-meson.png", desc: "チャームクォークを持つ。" },
            { id: 12, name: "J/psi", symbol: "J/ψ", rarity: "holo", mass: "3097", image: "images/j-psi.png", desc: "物理学の革命児。" },
            // ★ ここがないとLHCでフリーズします！
            { id: 13, name: "Top Quark", symbol: "t", rarity: "ultra", mass: "172760", image: "images/top-quark.png", desc: "最も重い素粒子。真理(Truth)の名を持つ。" },
            { id: 14, name: "Higgs Boson", symbol: "H⁰", rarity: "ultra", mass: "125100", image: "images/higgs.png", desc: "神の粒子。質量を与える起源。" }
        ];

        // プレースホルダー画像
        const placeholderImg = "https://placehold.co/300x200/333/FFF?text=Particle";

        // ★ ゲーム状態管理
        let collection = new Set();
        let budget = 1000;
        let accLevel = 1;

        // 加速器データ
        const accelerators = {
            1: { name: "30 GeV Synchrotron", nextCost: 3000, nextName: "J-PARC" },
            2: { name: "J-PARC (50 GeV)", nextCost: 10000, nextName: "LHC (14 TeV)" },
            3: { name: "LHC (14 TeV)", nextCost: 0, nextName: "MAX LEVEL" }
        };

        window.onload = function() {
            loadGame();
            updateUI();
            renderCollection();
        };

        // セーブ・ロード
        function saveGame() {
            localStorage.setItem('hadron_collection', JSON.stringify([...collection]));
            localStorage.setItem('hadron_budget', budget);
            localStorage.setItem('hadron_level', accLevel);
        }

        function loadGame() {
            const savedCol = localStorage.getItem('hadron_collection');
            if(savedCol) JSON.parse(savedCol).forEach(id => collection.add(id));
            
            const savedBudget = localStorage.getItem('hadron_budget');
            if(savedBudget) budget = parseInt(savedBudget);

            const savedLvl = localStorage.getItem('hadron_level');
            if(savedLvl) accLevel = parseInt(savedLvl);
        }

        // UI更新
        function updateUI() {
            document.getElementById('res-budget').innerText = budget;
            
            // 安全策：accLevelが異常値の場合のガード
            const acc = accelerators[accLevel] || accelerators[1];
            document.getElementById('acc-name').innerText = acc.name;

            const btn = document.getElementById('btn-upgrade');
            const costLabel = document.getElementById('upgrade-cost');
            
            if (accLevel >= 3) {
                btn.disabled = true;
                btn.innerText = "MAX LEVEL";
                costLabel.innerText = "";
            } else {
                btn.disabled = (budget < acc.nextCost);
                btn.innerHTML = `UPGRADE<br><span style="font-size:0.7rem;">Cost: ¥${acc.nextCost}</span>`;
            }
        }

        // ★ アップグレード実行
        function upgradeAccelerator() {
            const acc = accelerators[accLevel];
            if (budget >= acc.nextCost && accLevel < 3) {
                budget -= acc.nextCost;
                accLevel++;
                saveGame();
                updateUI();
                document.getElementById('status-msg').innerText = `System Upgraded to ${accelerators[accLevel].name}!`;
                document.getElementById('status-msg').style.color = "#00f3ff";
            }
        }

        // ★ ガチャ実行 (安全装置付き)
        function tryGacha(times) {
            try {
                const cost = 300 * times;
                if (budget < cost) {
                    alert("予算不足です！バトルに出撃して論文を書きましょう！");
                    return;
                }

                budget -= cost;
                updateUI();
                startGacha(times);
            } catch (e) {
                console.error(e);
                alert("エラーが発生しました: " + e.message);
            }
        }

        function startGacha(times) {
            const status = document.getElementById('status-msg');
            status.innerText = "COLLISION EXPERIMENT STARTED...";
            
            setTimeout(() => {
                try {
                    const result = getGachaResult();
                    collection.add(result.id);
                    saveGame();
                    renderCollection();
                    status.innerText = "PARTICLE OBSERVED.";
                    showResult(result);
                } catch (e) {
                    console.error(e);
                    alert("ガチャ処理中にエラーが発生しました。\nレアリティデータを確認してください。\n" + e.message);
                    status.innerText = "ERROR DETECTED.";
                }
            }, 800);
        }

        // ★ 確率計算 & エラー回避
        function getGachaResult() {
            const rand = Math.random();
            let rarity = 'common';

            // レベルごとの確率設定
            if (accLevel === 1) { // 30GeV
                if (rand > 0.85) rarity = 'rare';
                else rarity = 'common';
            } else if (accLevel === 2) { // J-PARC
                if (rand > 0.95) rarity = 'holo';
                else if (rand > 0.75) rarity = 'rare';
                else rarity = 'common';
            } else { // LHC (Max)
                if (rand > 0.97) rarity = 'ultra'; // 3%
                else if (rand > 0.85) rarity = 'holo';
                else if (rand > 0.60) rarity = 'rare';
                else rarity = 'common';
            }

            // 指定されたレアリティの粒子リストを取得
            let candidates = particleDB.filter(p => p.rarity === rarity);
            
            // ★ 安全装置：もし候補が0人なら（Ultraが未実装など）、強制的にCommonから選ぶ
            // これでお金だけ減る現象を防ぎます！
            if(candidates.length === 0) {
                console.warn(`Rarity ${rarity} has no particles! Fallback to common.`);
                candidates = particleDB.filter(p => p.rarity === 'common');
            }
            
            // それでも0なら（データ全消滅など）、プロトンを返す
            if(candidates.length === 0) return particleDB[0];

            return candidates[Math.floor(Math.random() * candidates.length)];
        }

        function renderCollection() {
            const list = document.getElementById('collection-list');
            list.innerHTML = '';
            particleDB.forEach(p => {
                const div = document.createElement('div');
                const isGot = collection.has(p.id);
                div.className = `mini-card ${isGot ? 'got' : ''}`;
                
                let star = "";
                if(p.rarity==='holo') star = "★";
                if(p.rarity==='ultra') star = '<span class="mini-rarity-ultra">UR</span>';

                div.innerHTML = `
                    <div style="font-weight:bold; color:white; font-size:1.2rem;">${isGot ? p.symbol : '?'}</div>
                    <div style="position:absolute; top:2px; left:2px; font-size:0.7rem; color:#ffd700;">${star}</div>
                `;
                div.onclick = () => { if(isGot) showResult(p); };
                list.appendChild(div);
            });
        }

        function showResult(p) {
            const overlay = document.getElementById('result-overlay');
            const card = document.getElementById('single-result');
            
            // クラスリセット
            card.className = "particle-card"; 
            if(p.rarity === 'ultra') card.classList.add('rarity-ultra');
            else if(p.rarity === 'holo') card.style.borderColor = "#f1c40f";
            else if(p.rarity === 'rare') card.style.borderColor = "#3498db";
            else card.style.borderColor = "#ccc";

            document.getElementById('card-img').src = p.image || placeholderImg;
            document.getElementById('card-name').innerText = p.name;
            document.getElementById('card-rarity').innerText = p.rarity.toUpperCase();
            document.getElementById('card-desc').innerText = p.desc;
            
            overlay.style.display = 'flex';
            card.style.display = 'block';
        }

        function closeResult() {
            document.getElementById('result-overlay').style.display = 'none';
        }
    </script>
</body>
</html>
