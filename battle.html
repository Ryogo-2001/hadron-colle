<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Fleet Battle | Hadron Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=M+PLUS+Rounded+1c:wght@700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #050505; color: white; font-family: 'M PLUS Rounded 1c'; overflow: hidden; background-size: 30px 30px; background-image: radial-gradient(#111 20%, transparent 20%), radial-gradient(#111 20%, transparent 20%); background-position: 0 0, 15px 15px; }
        
        .header { padding: 15px; display: flex; justify-content: space-between; background: rgba(0,0,0,0.8); border-bottom: 2px solid #444; }
        .btn-back { padding: 10px 20px; background: transparent; border: 2px solid #555; color: white; cursor: pointer; font-family: 'Orbitron'; }
        
        /* 戦闘画面レイアウト */
        .battle-field { height: 65vh; display: flex; position: relative; }
        
        /* 左側：味方艦隊 */
        .fleet-side {
            width: 50%; height: 100%; position: relative;
            display: flex; flex-direction: column-reverse; /* 手前が一番下 */
            justify-content: center; padding-left: 50px;
        }
        .fleet-member {
            width: 150px; height: 150px; object-fit: contain;
            margin-top: -80px; /* 重ねる */
            filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.8));
            transition: 0.2s; position: relative; z-index: 1;
            animation: float 3s ease-in-out infinite;
        }
        .fleet-member:hover { transform: scale(1.1); z-index: 10; }
        .fleet-member.flagship { width: 220px; height: 220px; z-index: 5; margin-bottom: 20px; }

        /* 右側：敵 */
        .enemy-side { width: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .enemy-core {
            width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle, #f1c40f, #d35400);
            box-shadow: 0 0 50px #e67e22; border: 5px solid white;
            display: flex; justify-content: center; align-items: center; font-size: 3rem; font-weight: bold;
            text-shadow: 2px 2px 0 #000; animation: pulse 2s infinite;
        }
        .hp-container { width: 300px; height: 20px; background: #333; margin-top: 20px; border: 1px solid #555; border-radius: 10px; overflow: hidden; }
        .hp-bar { width: 100%; height: 100%; background: #e74c3c; transition: width 0.2s; }

        /* コントロール */
        .panel { height: 25vh; background: #111; border-top: 2px solid #333; display: flex; padding: 20px; gap: 20px; }
        .log { flex: 2; background: #000; border: 1px solid #333; padding: 10px; overflow-y: auto; font-family: monospace; color: #2ecc71; }
        .actions { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .btn-fire { width: 100%; padding: 20px; background: #c0392b; color: white; font-family: 'Orbitron'; font-size: 1.5rem; border: none; cursor: pointer; }
        .btn-fire:disabled { background: #333; cursor: not-allowed; }

        /* エフェクト */
        .beam { position: absolute; height: 10px; background: #00f3ff; box-shadow: 0 0 20px #00f3ff; opacity: 0; }
        
        @keyframes float { 0%,100%{transform:translateX(0)} 50%{transform:translateX(10px)} }
        @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
    </style>
</head>
<body>
    <div class="header">
        <div>FLEET POWER: <span id="total-atk" style="color:#3498db">0</span> GeV</div>
        <button class="btn-back" onclick="location.href='index.html'">RETREAT</button>
    </div>

    <div class="battle-field">
        <div class="fleet-side" id="fleet-container">
            </div>
        <div class="enemy-side">
            <div class="enemy-core" id="enemy">Au</div>
            <div class="hp-container"><div class="hp-bar" id="hp-bar"></div></div>
        </div>
    </div>

    <div class="panel">
        <div class="log" id="log">Initializing Battle System...</div>
        <div class="actions">
            <button class="btn-fire" id="btn-fire" onclick="attack()">ALL OUT ATTACK</button>
        </div>
    </div>

    <script>
        const particles = [
            { id: 1, name: "Muon", rarity: 1, image: "images/proton.png" },
            { id: 2, name: "Electron", rarity: 1, image: "images/proton.png" },
            { id: 3, name: "Proton", rarity: 1, image: "images/proton.png" },
            { id: 4, name: "Pion", rarity: 2, image: "images/pion.png" },
            { id: 5, name: "Kaon", rarity: 3, image: "images/kaon.png" },
            { id: 6, name: "J/psi", rarity: 4, image: "images/j-psi.png" },
            { id: 7, name: "Higgs", rarity: 5, image: "images/higgs.png" },
            { id: 8, name: "Top Quark", rarity: 5, image: "images/top-quark.png" }
        ];

        let user = {};
        let totalAtk = 0;
        let enemyHp = 2000;
        const maxHp = 2000;

        window.onload = function() {
            const d = localStorage.getItem('hadron_v8');
            if(d) user = JSON.parse(d);
            
            // デッキ描画 & 攻撃力計算
            const container = document.getElementById('fleet-container');
            const deck = user.deck || [3,null,null,null,null]; // fallback
            
            let memberCount = 0;
            deck.forEach((pid, idx) => {
                if(pid) {
                    memberCount++;
                    const p = particles.find(x => x.id === pid) || particles[2];
                    const img = document.createElement('img');
                    img.src = p.image;
                    img.className = 'fleet-member';
                    if(idx === 0) img.classList.add('flagship'); // 1番目は旗艦（大きい）
                    
                    // 攻撃力加算 (レア度 * 100)
                    totalAtk += (p.rarity * 150);
                    container.appendChild(img);
                }
            });

            // 検出器ボーナス
            totalAtk += (user.invDet || []).length * 50;
            
            if(memberCount === 0) {
                log("No fleet deployed! Default Proton launched.");
                const img = document.createElement('img'); img.src="images/proton.png"; img.className='fleet-member flagship';
                container.appendChild(img);
                totalAtk = 100;
            }

            document.getElementById('total-atk').innerText = totalAtk;
            log(`Fleet deployed. Total Power: ${totalAtk}`);
        };

        function log(msg) {
            const div = document.getElementById('log');
            div.innerHTML += `> ${msg}<br>`;
            div.scrollTop = div.scrollHeight;
        }

        function attack() {
            const btn = document.getElementById('btn-fire');
            btn.disabled = true;
            
            // アニメーション
            const fleet = document.querySelectorAll('.fleet-member');
            fleet.forEach(img => {
                img.style.transform = 'translateX(50px)';
                setTimeout(()=>img.style.transform='translateX(0)', 200);
            });

            // ダメージ計算
            const dmg = Math.floor(totalAtk * (0.9 + Math.random()*0.2));
            enemyHp -= dmg;
            if(enemyHp < 0) enemyHp = 0;
            
            const pct = (enemyHp / maxHp) * 100;
            document.getElementById('hp-bar').style.width = pct + "%";
            
            log(`Volley fired! Target damage: ${dmg}`);

            if(enemyHp <= 0) {
                log("Target Destroyed!");
                document.getElementById('enemy').style.transform = 'scale(0)';
                setTimeout(() => { alert("VICTORY! Material Gained."); location.href='index.html'; }, 1000);
            } else {
                setTimeout(() => btn.disabled = false, 800);
            }
        }
    </script>
</body>
</html>
