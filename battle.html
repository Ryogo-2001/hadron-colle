<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Tactical Battle2 | Hadron Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=M+PLUS+Rounded+1c:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="script.js"></script>
</head>
<body>

    <div id="skill-overlay" class="skill-cutin">LIMIT BREAK!</div>
    
    <div class="header">
        <div style="font-family:'Orbitron'">MISSION: <span style="color:red" id="mission-name">Loading...</span></div>
        <button class="btn-back" onclick="location.href='index.html'">RETREAT</button>
    </div>

    <div class="battle-field">
        <div class="player-side">
            <div class="fleet-stats-box">
                <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                    <span>FLEET HP</span> <span id="p-hp-val">0</span>
                </div>
                <div class="bar-container"><div id="p-hp-bar" class="hp-bar" style="width:100%"></div></div>
                <div class="bar-container" style="height:4px; background:#444;"><div id="p-ep-bar" class="ep-bar"></div></div>
                <div style="text-align:right; font-size:0.7rem; color:#f1c40f;">TP (Tactical Point)</div>
                <div id="buff-container" class="buff-list"></div>
            </div>
            <div id="fleet-container" class="fleet-container"></div>
        </div>

        <div class="enemy-side">
            <div class="fleet-stats-box" style="position:relative; top:0; left:0; width:200px; border-color:#e74c3c;">
                <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                    <span>BOSS HP</span> <span id="e-hp-val">0</span>
                </div>
                <div class="bar-container"><div id="e-hp-bar" class="hp-bar" style="background:#e74c3c; width:100%"></div></div>
            </div>
            <div id="enemy-core" class="enemy-core" style="margin-top:20px;"></div>
        </div>
    </div>

    <div class="command-panel">
        <div class="log-window" id="log">
            > Initializing Battle System...
        </div>
        <div class="command-grid">
            <button class="cmd-btn" style="--color:#3498db" onclick="playerAction('attack')">
                üî• ALL-OUT ATTACK
                <div style="font-size:0.7rem; color:#aaa;">TP +15</div>
            </button>
            <button class="cmd-btn" style="--color:#2ecc71" onclick="playerAction('charge')">
                üõ° RECHARGE
                <div style="font-size:0.7rem; color:#aaa;">TP +40</div>
            </button>
            <button id="btn-skill" class="cmd-btn" style="--color:#f1c40f; grid-column: span 2;" onclick="playerAction('skill')" disabled>
                ‚òÖ <span id="skill-name">SKILL</span>
                <div style="font-size:0.7rem; color:#aaa;">Cost: 100 TP</div>
            </button>
        </div>
    </div>

    <div id="result-modal" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h1 id="res-title" style="color:gold">MISSION ACCOMPLISHED</h1>
            <p id="res-msg">Target Destroyed.</p>
            <div style="margin:20px 0; border-top:1px solid #444; padding-top:20px;">
                <div>LOOT ACQUIRED:</div>
                <div id="loot-display" style="font-size:1.5rem; margin:10px 0; line-height:1.5;"></div>
            </div>
            <button class="btn-back" onclick="location.href='index.html'" style="background:#333; margin-top:10px;">RETURN</button>
        </div>
    </div>

    <script>
        // === „Éê„Éà„É´Âõ∫ÊúâÂ§âÊï∞ ===
        // script.js„ÅÆÂ§âÊï∞„Çí‰∏äÊõ∏„Åç„Åó„Å™„ÅÑ„Çà„ÅÜ„ÄÅÂõ∫Êúâ„ÅÆ„ÇÇ„ÅÆ„Å†„ÅëÂÆ£Ë®Ä
        let deckMembers = [];
        let flagShip = null;
        let stats = { hp: 0, maxHp: 0, ep: 0, atk: 0, regen: 0, critRate: 0.1, dmgRed: 0 };
        let enemy = { hp: 0, maxHp: 0, atk: 0 };
        let isPlayerTurn = true;
        let activeBuffs = [];
        
        // ‚ÄªÈáçË¶Å: currentMission „ÅØÂÆ£Ë®Ä„Åõ„Åö„ÄÅscript.js „ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Çí‰Ωø„ÅÑ„Åæ„ÅôÔºÅ

        window.onload = function() {
            // script.js„ÅÆ„É≠„Éº„ÉâÁ¢∫Ë™ç„Å®„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
            if(typeof loadGame === 'function') {
                loadGame(); 
            } else {
                console.error("script.js not loaded.");
                return;
            }

            // „Éü„ÉÉ„Ç∑„Éß„É≥ID„ÅÆÂèñÂæó„Å®Ë®≠ÂÆö
            const params = new URLSearchParams(window.location.search);
            const mid = params.get('mission') || 'm1';
            // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÅÆ currentMission „Å´‰ª£ÂÖ•
            currentMission = missionData[mid] || missionData['m1'];

            // UIÂèçÊò†
            document.getElementById('mission-name').innerText = currentMission.name;
            const core = document.getElementById('enemy-core');
            core.innerText = currentMission.symbol;
            core.style.background = `radial-gradient(circle, ${currentMission.color}, #000)`;
            core.style.boxShadow = `0 0 60px ${currentMission.color}`;

            // „Çπ„Ç≠„É´Ë£úÊ≠£ (script.js„ÅÆÈñ¢Êï∞)
            const atkBonus = getSkillBonus('atk_up');
            const allBonus = getSkillBonus('all_up');
            const regenBonus = getSkillBonus('regen_up');
            
            // „Éá„ÉÉ„Ç≠ÊßãÁØâ
            const deckIds = user.deck || [1, null, null, null, null];
            const container = document.getElementById('fleet-container');
            
            deckIds.forEach((pid, index) => {
                if(pid) {
                    const p = particles.find(x => x.id === pid) || particles[0]; 
                    let currentImg = getImgSrc(p); // script.js„ÅÆÈñ¢Êï∞
                    deckMembers.push({ ...p, index: index, image: currentImg });
                }
            });
            // „Éá„ÉÉ„Ç≠„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅÆÂÆâÂÖ®Á≠ñ
            if(deckMembers.length === 0) {
                const p = particles[0];
                deckMembers.push({ ...p, index: 0, image: p.image });
            }

            flagShip = deckMembers[0]; 
            document.getElementById('skill-name').innerText = flagShip.skill;

            // „Çπ„ÉÜ„Éº„Çø„ÇπË®àÁÆó
            deckMembers.forEach((member, i) => {
                const img = document.createElement('img');
                img.src = member.image;
                img.className = 'fleet-member';
                const offset = i * 60;
                img.style.left = `${offset}px`;
                img.style.top = `${-offset * 0.3}px`;
                img.style.zIndex = 50 - i;
                if(i === 0) img.classList.add('flagship');
                container.appendChild(img);
                
                let rVal = 1;
                if(member.rarity=="rare") rVal=2;
                if(member.rarity=="holo") rVal=4;
                if(member.rarity=="ultra") rVal=8;
                if(member.rarity=="genesis") rVal=20; 

                let baseHp = 500 + rVal * 200;
                let baseAtk = 100 + rVal * 150;

                // ÂêçÂ£∞„Éú„Éº„Éä„Çπ
                const info = getFameInfo(member.id); // script.js„ÅÆÈñ¢Êï∞
                const fameMult = 1 + info.bonus;

                // „Çπ„Ç≠„É´Ë£úÊ≠£
                let skillMultAtk = 1 + atkBonus + allBonus;
                let skillMultHp = 1 + allBonus;

                stats.maxHp += baseHp * fameMult * skillMultHp;
                stats.atk += baseAtk * fameMult * skillMultAtk;
                
                if(info.lv > 0) console.log(`${member.name} Fame Lv.${info.lv} (x${fameMult.toFixed(2)})`);
            });

            // Ëá™ÂãïÂõûÂæ©
            if(regenBonus > 0) stats.regen += Math.floor(stats.maxHp * 0.03 * (1+regenBonus));

            applyFleetBuffs();
            
            // Êïµ„Çπ„ÉÜ„Éº„Çø„ÇπË®≠ÂÆö
            enemy.maxHp = Math.floor(Math.max(1000, stats.atk * 10 * currentMission.hpMult));
            enemy.hp = enemy.maxHp;
            enemy.atk = Math.floor(Math.max(50, stats.maxHp / 8 * currentMission.atkMult));
            
            stats.hp = stats.maxHp;
            updateUI();
            
            const l = document.getElementById('log');
            l.innerHTML = `> Mission Start: ${currentMission.name}<br>> Hostile Detected.<br>> Awaiting orders...`;
        };

        // --- „Éê„Éà„É´„É≠„Ç∏„ÉÉ„ÇØ ---
        function applyFleetBuffs() {
            let types = { atk:0, def:0, spd:0, ult:0 };
            let ids = deckMembers.map(m => m.id);
            deckMembers.forEach(m => { if(types[m.type] !== undefined) types[m.type]++; });

            if(types.atk >= 3) { stats.atk *= 1.2; addBuff("‚öîÔ∏è ASSAULT: Atk+20%"); }
            if(types.def >= 3) { stats.maxHp *= 1.2; addBuff("üõ° FORTRESS: HP+20%"); }
            if(types.spd >= 3) { stats.ep += 30; addBuff("‚ö° RAPID: Start TP+30"); }

            if(ids.includes(1) && ids.includes(2)) { stats.maxHp *= 1.15; addBuff("‚öõÔ∏è Nucleus: HP+15%"); }
            if(ids.includes(13) && ids.includes(14)) { stats.atk *= 1.30; addBuff("‚öñÔ∏è God Particle: Atk+30%"); }
            if(ids.includes(17) && ids.includes(12)) { stats.atk *= 1.15; addBuff("üíñ Charm: Atk+15%"); }
            if(ids.includes(19)) { stats.atk *= 1.25; stats.maxHp *= 0.9; addBuff("‚ö´ Antimatter: Atk UP/HP DOWN"); }

            if(ids.includes(21) && ids.includes(22)) { stats.regen += Math.floor(stats.maxHp * 0.05); addBuff("‚ôªÔ∏è Weak Force: Regen 5%"); }
            if(ids.includes(20) && ids.includes(15)) { stats.critRate += 0.2; addBuff("üí• Gamma Burst: Crit+20%"); }
            if(ids.includes(23)) { stats.dmgRed += 0.15; addBuff("üîÆ Future Sight: Dmg Cut 15%"); }
            if(ids.includes(24)) { stats.atk *= 1.4; enemy.atk *= 0.8; addBuff("üåå Gravity Well: Atk+40%/E.Atk-20%"); }
        }

        function addBuff(name) {
            activeBuffs.push(name);
            const el = document.getElementById('buff-container');
            const tag = document.createElement('div');
            tag.className = 'buff-tag';
            tag.innerText = name;
            el.appendChild(tag);
        }

        function updateUI() {
            if(stats.hp <= 0 && stats.maxHp > 0 && isPlayerTurn && enemy.hp == enemy.maxHp) stats.hp = stats.maxHp; 
            document.getElementById('p-hp-val').innerText = Math.floor(stats.hp);
            document.getElementById('p-hp-bar').style.width = Math.min(100, (stats.hp/stats.maxHp*100)) + "%";
            document.getElementById('p-ep-bar').style.width = stats.ep + "%";
            document.getElementById('e-hp-val').innerText = Math.floor(enemy.hp);
            document.getElementById('e-hp-bar').style.width = Math.min(100, (enemy.hp/enemy.maxHp*100)) + "%";
            document.getElementById('btn-skill').disabled = (stats.ep < 100 || !isPlayerTurn);
            const btns = document.querySelectorAll('.cmd-btn');
            btns.forEach(b => { if(b.id!=='btn-skill') b.disabled = !isPlayerTurn; });
        }
        function log(msg) { const l = document.getElementById('log'); l.innerHTML += `> ${msg}<br>`; l.scrollTop = l.scrollHeight; }

        function playerAction(type) {
            if(!isPlayerTurn) return; isPlayerTurn = false; updateUI();
            if(type === 'attack') {
                log("Fleet All-Out Attack!"); animFleetAttack();
                setTimeout(() => {
                    let isCrit = Math.random() < stats.critRate;
                    let dmg = stats.atk * (0.9 + Math.random()*0.2);
                    if(isCrit) { dmg *= 1.5; log("<span style='color:gold'>CRITICAL HIT!</span>"); }
                    dealDamageToEnemy(Math.floor(dmg), isCrit); addEp(15); endTurn();
                }, 600);
            } else if(type === 'charge') {
                log("Fleet recharging energy..."); addEp(40); setTimeout(endTurn, 800);
            } else if(type === 'skill') { useSkill(); }
        }

        function useSkill() {
            stats.ep = 0; updateUI();
            const overlay = document.getElementById('skill-overlay'); overlay.innerText = flagShip.skill + "!!"; overlay.classList.add('active');
            setTimeout(() => {
                overlay.classList.remove('active'); animFleetAttack();
                let multiplier = 2.5; 
                if(flagShip.rarity === 'ultra') multiplier = 4.0; 
                if(flagShip.rarity === 'genesis') multiplier = 10.0;
                const dmg = stats.atk * multiplier;
                log(`<span style="color:gold">FLAGSHIP SKILL FIRE!</span>`);
                setTimeout(() => { dealDamageToEnemy(Math.floor(dmg), true); endTurn(); }, 600);
            }, 1500);
        }

        function endTurn() { if(enemy.hp <= 0) return; log("Enemy Turn..."); setTimeout(enemyAction, 1000); }

        function enemyAction() {
            const elm = document.getElementById('enemy-core'); elm.style.transform = 'scale(1.2)';
            setTimeout(() => {
                elm.style.transform = 'scale(1)';
                let rawDmg = enemy.atk * (0.8 + Math.random()*0.4);
                if(stats.dmgRed > 0) { rawDmg *= (1.0 - stats.dmgRed); log(`(Buff protected ${Math.floor(stats.dmgRed*100)}% damage)`); }
                log("Enemy counter-attack!"); dealDamageToPlayer(Math.floor(rawDmg));
                if(stats.hp > 0) { applyRegen(); isPlayerTurn = true; updateUI(); log("Command Phase."); }
            }, 500);
        }

        function applyRegen() {
            if(stats.regen > 0 && stats.hp < stats.maxHp) { 
                stats.hp = Math.min(stats.maxHp, stats.hp + stats.regen); 
                showHeal(stats.regen, 'fleet-container'); 
                log(`<span style='color:#2ecc71'>Auto-Repair: +${Math.floor(stats.regen)} HP</span>`); 
                updateUI(); 
            }
        }

        function animFleetAttack() { const mems = document.querySelectorAll('.fleet-member'); mems.forEach((img, i) => { setTimeout(() => { img.classList.add('attack'); setTimeout(()=>img.classList.remove('attack'), 300); }, i * 50); }); }

        function dealDamageToEnemy(amount, isCrit) {
            enemy.hp -= amount; if(enemy.hp < 0) enemy.hp = 0; showDamage(amount, 'enemy-core', isCrit);
            const elm = document.getElementById('enemy-core'); elm.classList.add('damage'); setTimeout(()=>elm.classList.remove('damage'), 300);
            updateUI(); 
            if(enemy.hp <= 0) { 
                log("<span style='color:gold'>TARGET SILENCED.</span>"); 
                // script.js„ÅÆwinGame„ÇíÂëº„Å∂
                setTimeout(() => { if(typeof winGame === 'function') winGame(); }, 1000); 
            }
        }

        function dealDamageToPlayer(amount) {
            stats.hp -= amount; if(stats.hp < 0) stats.hp = 0; updateUI();
            const mems = document.querySelectorAll('.fleet-member'); mems.forEach(img => { img.classList.add('damage'); setTimeout(()=>img.classList.remove('damage'), 400); });
            showDamage(amount, 'fleet-container', false); if(stats.hp <= 0) { log("<span style='color:red'>FLEET CRITICAL...</span>"); setTimeout(loseGame, 1000); }
        }

        function showDamage(val, targetId, isCrit) {
            const target = document.getElementById(targetId); const rect = target.getBoundingClientRect(); const el = document.createElement('div'); el.className = 'damage-pop'; el.innerText = val;
            if(isCrit) { el.style.color = 'gold'; el.style.fontSize = '4rem'; }
            el.style.left = (rect.left + rect.width/2 - 20) + 'px'; el.style.top = (rect.top) + 'px'; document.body.appendChild(el); setTimeout(()=>el.remove(), 800);
        }

        function showHeal(val, targetId) {
            const target = document.getElementById(targetId); const rect = target.getBoundingClientRect(); const el = document.createElement('div'); el.className = 'heal-pop'; el.innerText = "+" + val;
            el.style.left = (rect.left + rect.width/2) + 'px'; el.style.top = (rect.top) + 'px'; document.body.appendChild(el); setTimeout(()=>el.remove(), 800);
        }

        function addEp(v) { stats.ep = Math.min(100, stats.ep + v); updateUI(); }

        function loseGame() {
            document.getElementById('res-title').innerText = "DEFEAT"; 
            document.getElementById('res-title').style.color = "red"; 
            document.getElementById('loot-display').style.display = "none"; 
            document.getElementById('result-modal').style.display = 'flex';
        }
    </script>
</body>
</html>
